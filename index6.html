<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Créateur de Site PRO v2</title>
<style id="main-styles">
    :root {
        --color-accent: #007bff; --color-heading: #212529; --color-text: #343a40; --color-bg: #ffffff; --color-surface: #f8f9fa;
        --border-color: #dee2e6; --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        --shadow-sm: 0 2px 10px rgba(0,0,0,0.07); --shadow-md: 0 5px 20px rgba(0,0,0,0.1);
    }
    html.dark-theme {
        --color-accent: #4dabf7; --color-heading: #ffffff; --color-text: #ced4da; --color-bg: #121212; --color-surface: #1e2022;
        --border-color: #495057;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: var(--font-main); background-color: #eef1f3; color: #333; line-height: 1.6; }
    .container { display: flex; height: 100vh; }
    .customizer { width: 420px; background: #fff; padding: 25px; box-shadow: var(--shadow-md); overflow-y: auto; display: flex; flex-direction: column; z-index: 10; }
    .customizer h2 { margin-bottom: 20px; border-bottom: 2px solid var(--color-accent); padding-bottom: 10px; color: #2c3e50; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #34495e; font-size: 0.9rem; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: inherit; transition: border-color 0.3s; background: #fdfdfd; font-size: 1rem; }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { border-color: var(--color-accent); outline: none; box-shadow: 0 0 5px rgba(0, 123, 255, 0.25); }
    .form-group textarea { min-height: 100px; resize: vertical; }
    .form-group.color-input { display: flex; align-items: center; justify-content: space-between; }
    .form-group.color-input input[type="color"] { width: 50px; height: 35px; padding: 2px; border: none; background: none; cursor: pointer; }
    .form-group.color-input .color-value { font-family: monospace; background: #f1f1f1; padding: 5px 8px; border-radius: 4px; }
    .tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 20px; }
    .tabs button { padding: 12px 5px; cursor: pointer; background: #f9f9f9; border: 1px solid #ddd; font-weight: 600; transition: all 0.3s; border-radius: 5px; font-size:0.9rem; flex-grow: 1; }
    .tabs button.active { background: var(--color-accent); color: white; border-color: var(--color-accent); }
    .preview { flex: 1; padding: 20px; background-color: #dce3e9; display: flex; justify-content: center; align-items: center; }
    .preview-frame { width: 100%; height: 100%; display: flex; flex-direction: column; }
    .preview-container { width: 100%; flex: 1; border: 8px solid #333; border-radius: 10px; background: var(--color-bg); color: var(--color-text); box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; display: flex; flex-direction: column; }
    .btn { display: inline-block; padding: 12px 25px; background: var(--color-accent); color: #fff; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; text-align: center; text-decoration: none; transition: all 0.3s; font-size: 1rem; }
    .btn:hover { filter: brightness(1.1); transform: translateY(-2px); box-shadow: var(--shadow-sm); }
    .btn-group { margin-top: auto; padding-top: 20px; border-top: 1px solid #eee; display: flex; flex-wrap: wrap; gap: 10px; }
    .btn-group .btn { flex-grow: 1; font-size: 0.9rem; }
    .btn.btn-secondary { background-color: #6c757d; }
    hr.form-divider { border: none; border-top: 1px solid #eee; margin: 25px 0; }

    /* Styles pour la modale de demande */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-content { background: #fff; padding: 30px; border-radius: 8px; box-shadow: var(--shadow-md); width: 90%; max-width: 500px; position: relative; transform: scale(0.9); transition: transform 0.3s; }
    .modal-overlay.visible .modal-content { transform: scale(1); }
    .modal-content h3 { margin-top: 0; margin-bottom: 15px; }
    .modal-close-btn { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #888; }

    /* --- Styles communs pour la prévisualisation --- */
    #websitePreview { height: 100%; overflow-y: auto; font-family: var(--font-main); background: var(--color-bg); color: var(--color-text); scroll-behavior: smooth; }
    #websitePreview .page-content { display: none; }
    #websitePreview .page-content.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #websitePreview h1 { color: var(--color-heading); } #websitePreview h2 { color: var(--color-heading); } #websitePreview h3 { color: var(--color-heading); }
    #websitePreview .btn { background: var(--color-accent); color: #fff; text-decoration: none; }
    #websitePreview .section { padding: 60px 5%; }
    #websitePreview .section-alt { background-color: var(--color-surface); }
    #websitePreview .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 25px; }
    #websitePreview .card { background: var(--color-bg); padding: 25px; border-radius: 8px; box-shadow: var(--shadow-sm); }
    #websitePreview a { color: var(--color-accent); }
    #websitePreview footer { text-align:center; padding: 40px 20px; }

    /* === STYLES TEMPLATE: ARTISAN (Défaut) === */
    .template-artisan header { position: sticky; top: 0; z-index: 1000; background: var(--color-surface); box-shadow: var(--shadow-sm); }
    .template-artisan nav { display:flex; justify-content:space-between; align-items:center; padding: 15px 5%; }
    .template-artisan .logo-container .logo { font-size:1.6rem; font-weight:700; color: var(--color-accent); }
    .template-artisan .logo-container .subtext { font-size: 0.9rem; color: var(--color-text); opacity: 0.8; }
    .template-artisan nav ul { list-style:none; display:flex; gap:30px; }
    .template-artisan nav a { color: var(--color-text); text-decoration:none; font-weight:600; padding-bottom: 5px; border-bottom: 2px solid transparent; transition: all 0.3s; }
    .template-artisan nav a.active, .template-artisan nav a:hover { color: var(--color-accent); border-bottom-color: var(--color-accent); }
    .template-artisan .hero { display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; min-height: 60vh; color: #fff; background-size: cover; background-position: center; padding: 20px; position: relative; }
    .template-artisan .hero::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 0; }
    .template-artisan .hero-content { position: relative; z-index: 1; }
    .template-artisan h1 { font-size: clamp(2rem, 5vw, 3rem); color: #fff; } .template-artisan h2 { text-align: center; margin-bottom: 40px; }
    .template-artisan .about p { max-width: 800px; margin: 20px auto 0; text-align: center; font-size: 1.1rem; }
    .template-artisan .catalog-item { padding: 0; transition: transform 0.3s, box-shadow 0.3s; }
    .template-artisan .catalog-item:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); }
    .template-artisan .catalog-item img { width: 100%; height: 200px; object-fit: cover; border-top-left-radius: 8px; border-top-right-radius: 8px; }
    .template-artisan .catalog-item .item-content { padding: 20px; }
    .template-artisan footer { background: #212529; color: #fff; }
    .template-artisan .social-links a { color: #fff; font-size: 1.5rem; margin: 0 10px; transition: color 0.3s; }
    .template-artisan .social-links a:hover { color: var(--color-accent); }

    /* === STYLES TEMPLATE: CORPORATE MODERNE === */
    .template-corporate { font-family: 'Poppins', var(--font-main); }
    .template-corporate header { background: var(--color-bg); border-bottom: 1px solid var(--border-color); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
    .template-corporate .logo { font-size: 1.8rem; font-weight: 600; color: var(--color-heading); }
    .template-corporate nav ul { list-style: none; display: flex; gap: 25px; }
    .template-corporate nav a { text-decoration: none; color: var(--color-text); font-weight: 500; position: relative; padding: 5px 0; }
    .template-corporate nav a::after { content: ''; position: absolute; bottom: 0; left: 0; width: 0; height: 2px; background: var(--color-accent); transition: width 0.3s; }
    .template-corporate nav a:hover::after, .template-corporate nav a.active::after { width: 100%; }
    .template-corporate .hero { background-color: var(--color-surface); display: grid; grid-template-columns: 1fr 1fr; align-items: center; gap: 40px; min-height: 80vh; padding: 60px 5%;}
    .template-corporate .hero-text h1 { font-size: clamp(2.5rem, 6vw, 3.5rem); line-height: 1.2; }
    .template-corporate .hero-text p { font-size: 1.2rem; margin: 20px 0 30px; }
    .template-corporate .hero-image { width: 100%; height: 100%; object-fit: cover; border-radius: 10px; box-shadow: var(--shadow-md); }
    .template-corporate h2 { text-align: center; font-size: 2.2rem; margin-bottom: 40px; }
    .template-corporate footer { background-color: var(--color-surface); color: var(--color-text); border-top: 1px solid var(--border-color); }

    /* === STYLES TEMPLATE: PORTFOLIO CRÉATIF === */
    .template-portfolio { background-color: var(--color-bg); }
    .template-portfolio header { padding: 40px; text-align: center; }
    .template-portfolio .logo { font-size: 2.5rem; font-weight: 300; letter-spacing: 2px; color: var(--color-heading); }
    .template-portfolio .subtext { font-size: 1rem; color: var(--color-text); margin-top: 5px; }
    .template-portfolio nav { text-align: center; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); padding: 15px 0; margin-bottom: 40px; }
    .template-portfolio nav ul { list-style: none; display: inline-flex; gap: 40px; }
    .template-portfolio nav a { text-decoration: none; color: var(--color-text); font-weight: 500; }
    .template-portfolio nav a.active { color: var(--color-accent); font-weight: 700; }
    .template-portfolio h1, .template-portfolio h2 { text-align: center; font-weight: 400; }
    .template-portfolio .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; padding: 0 10px; }
    .template-portfolio .gallery-item { position: relative; overflow: hidden; }
    .template-portfolio .gallery-item img { width: 100%; height: 100%; object-fit: cover; display: block; transition: transform 0.4s ease; }
    .template-portfolio .gallery-item:hover img { transform: scale(1.1); }
    .template-portfolio .gallery-item figcaption { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; text-align: center; padding: 10px; transform: translateY(100%); transition: transform 0.4s ease; }
    .template-portfolio .gallery-item:hover figcaption { transform: translateY(0); }
    .template-portfolio .section { max-width: 900px; margin: 0 auto; }
    .template-portfolio footer { background: var(--color-bg); color: var(--color-text); font-size: 0.9rem; }
</style>
</head>
<body>
<div class="container">
    <div class="customizer">
        <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
        
        <div class="tabs">
            <button class="tab-btn active" data-page="general">Général</button>
            <button class="tab-btn" data-page="accueil">Accueil</button>
            <button class="tab-btn" data-page="catalogue">Catalogue</button>
            <button class="tab-btn" data-page="galerie">Galerie</button>
            <button class="tab-btn" data-page="temoignages">Témoignages</button>
            <button class="tab-btn" data-page="contact">Contact</button>
        </div>
        <div id="tabContent"></div>
        <div class="btn-group">
            <button class="btn btn-secondary" id="importJsonBtn" title="Importer une configuration JSON"><i class="fas fa-upload"></i> Importer</button>
            <button class="btn btn-secondary" id="exportJsonBtn" title="Exporter la configuration en JSON"><i class="fas fa-file-code"></i> Exporter</button>
            <button class="btn" id="requestFeatureBtn" title="Demander une modification ou un nouveau module"><i class="fas fa-lightbulb"></i> Demander un ajout</button>
            <button class="btn" id="downloadBtn" title="Télécharger le site complet en HTML"><i class="fas fa-download"></i> Télécharger</button>
            <input type="file" id="importFileInput" accept="application/json" style="display: none;">
        </div>
    </div>
    <div class="preview">
        <div class="preview-frame">
              <div class="preview-container">
                    <div id="websitePreview"></div>
              </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="featureRequestModal">
    <div class="modal-content">
        <button class="modal-close-btn" id="modalCloseBtn">&times;</button>
        <h3>Demander un module ou une modification</h3>
        <p style="font-size:0.9rem; margin-bottom:15px; color: #555;">Décrivez votre besoin. Votre configuration actuelle sera jointe automatiquement à votre demande pour nous donner le contexte.</p>
        <form id="featureRequestForm" action="https://formsubmit.co/school.dlecointre@gmail.com" method="POST">
             <input type="hidden" name="_subject" value="Nouvelle demande d'ajout !">
            <input type="hidden" name="_next" value="${window.location.href}">
            <input type="hidden" name="_captcha" value="false"> <div class="form-group">
                <label for="featureName">Nom du module / de la modification</label>
                <input type="text" id="featureName" name="nom_de_la_demande" placeholder="Ex: Page Blog, Section 'Notre équipe'..." required>
            </div>
            <div class="form-group">
                <label for="featureDetails">Détails de votre demande</label>
                <textarea id="featureDetails" name="details_demande" placeholder="Décrivez le plus précisément possible ce que vous souhaitez." required></textarea>
            </div>
            <input type="hidden" name="configuration_json" id="jsonConfigInput">
            
            <button type="submit" class="btn">Envoyer la demande</button>
        </form>
    </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- 1. STATE & TEMPLATES ---

    let websiteData = {
        general: {
            siteTitle: "Artisan Créateur", headerSubtext: "L'excellence, sur mesure.", theme: "light", templateId: 'artisan',
            colorAccent: '#c0392b', colorHeading: '#2c3e50', colorText: '#34495e', colorBg: '#ffffff', colorSurface: '#ecf0f1',
        },
        accueil: {
            heroTitle: 'L\'Art de la Création', heroSubtitle: 'Donnez vie à vos projets avec un savoir-faire unique.', heroImage: 'https://images.unsplash.com/photo-1555949963-ff9fe0c870eb?q=80&w=2070&auto=format&fit=crop',
            ctaText: 'Découvrir nos services', ctaLink: '#catalogue',
            aboutTitle: 'Notre Histoire', aboutText: 'Passionnés par notre métier, nous combinons techniques traditionnelles et innovations pour des résultats qui dépassent vos attentes.',
        },
        catalogue: {
            pageTitle: 'Nos Services',
            items: [{ name: 'Conception sur Mesure', desc: 'Analyse et création d\'un plan détaillé.', price: 'Sur devis', image: 'https://images.unsplash.com/photo-1519389950473-47ba0277781c?q=80&w=2070&auto=format&fit=crop' }, { name: 'Fabrication Artisanale', desc: 'Réalisation dans notre atelier avec des matériaux de qualité.', price: 'À partir de 450€', image: 'https://images.unsplash.com/photo-1496247749665-49cf5b1022e7?q=80&w=2073&auto=format&fit=crop' }],
        },
        galerie: {
            pageTitle: 'Nos Réalisations',
            images: [
                { url: 'https://images.unsplash.com/photo-1638718260002-18bdc8082608?q=80&w=687&auto=format&fit=crop', caption: 'Projet résidentiel A' },
                { url: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?q=80&w=1170&auto=format&fit=crop', caption: 'Détail de fabrication' },
                { url: 'https://images.unsplash.com/photo-1581092446327-9b52bd35405a?q=80&w=1170&auto=format&fit=crop', caption: 'Innovation technique' },
            ]
        },
        temoignages: {
            title: 'Ce que disent nos clients',
            items: [ { text: 'Un professionnalisme et une écoute rares. Le résultat est au-delà de mes espérances.', author: 'Julien M.' } ]
        },
        contact: {
            pageTitle: 'Nous Contacter', introText: 'Un projet en tête ? Parlons-en ! Remplissez le formulaire ci-dessous ou utilisez nos coordonnées.', address: '5 Avenue de l\'Artisanat, 75012 Paris', phone: '01 23 45 67 89', email: 'contact@artisan.fr',
            footerText: `© ${new Date().getFullYear()} Artisan Créateur. Tous droits réservés.`,
            social: { facebook: 'https://facebook.com', instagram: 'https://instagram.com', linkedin: '' }
        }
    };
    
    // --- NOUVEAU: Système de Templates Avancé ---
    const templates = {
        'artisan': {
            name: 'Artisan (Défaut)',
            defaults: { colorAccent: '#c0392b', colorHeading: '#2c3e50', colorText: '#34495e', colorBg: '#ffffff', colorSurface: '#ecf0f1' },
            render: (data, activePage) => `
                <div class="template-artisan">
                    <header><nav>
                        <div class="logo-container"><div class="logo">${data.general.siteTitle}</div><div class="subtext">${data.general.headerSubtext}</div></div>
                        <ul>
                            <li><a href="#accueil" data-page="accueil" class="${activePage === 'accueil' ? 'active' : ''}">Accueil</a></li>
                            <li><a href="#catalogue" data-page="catalogue" class="${activePage === 'catalogue' ? 'active' : ''}">${data.catalogue.pageTitle.split(' ')[0] || 'Catalogue'}</a></li>
                            <li><a href="#galerie" data-page="galerie" class="${activePage === 'galerie' ? 'active' : ''}">Galerie</a></li>
                            <li><a href="#contact" data-page="contact" class="${activePage === 'contact' ? 'active' : ''}">Contact</a></li>
                        </ul>
                    </nav></header>
                    <main>
                        <div class="page-content ${activePage === 'accueil' ? 'active' : ''}" id="page-accueil">
                            <section class="hero" style="background-image: url('${data.accueil.heroImage}');"><div class="hero-content"><h1>${data.accueil.heroTitle}</h1><p>${data.accueil.heroSubtitle}</p><a href="${data.accueil.ctaLink}" class="btn cta-btn">${data.accueil.ctaText}</a></div></section>
                            <section class="section about"><h2>${data.accueil.aboutTitle}</h2><p>${data.accueil.aboutText.replace(/\n/g, '<br>')}</p></section>
                            <section class="section section-alt testimonials"><h2>${data.temoignages.title}</h2><div class="card-grid">${data.temoignages.items.map(t => `<div class="card testimonial-card"><p>"${t.text}"</p><div class="author">- ${t.author}</div></div>`).join('')}</div></section>
                        </div>
                        <div class="page-content ${activePage === 'catalogue' ? 'active' : ''}" id="page-catalogue">
                             <section class="section"><h2>${data.catalogue.pageTitle}</h2><div class="card-grid">${data.catalogue.items.map(i => `<div class="card catalog-item"><img src="${i.image}" alt="${i.name}"><div class="item-content"><h3>${i.name}</h3><p>${i.desc}</p>${i.price ? `<div class="price">${i.price}</div>` : ''}</div></div>`).join('')}</div></section>
                        </div>
                        <div class="page-content ${activePage === 'galerie' ? 'active' : ''}" id="page-galerie">
                            <section class="section"><h2>${data.galerie.pageTitle}</h2><div class="gallery-grid">${data.galerie.images.map(i => `<figure class="gallery-item"><img src="${i.url}" alt="${i.caption}"><figcaption>${i.caption}</figcaption></figure>`).join('')}</div></section>
                        </div>
                        <div class="page-content ${activePage === 'contact' ? 'active' : ''}" id="page-contact">
                            <section class="section"><h2>${data.contact.pageTitle}</h2><p style="text-align:center; max-width:700px; margin: 0 auto 40px;">${data.contact.introText}</p>
                                <form action="https://formsubmit.co/${data.contact.email}" method="POST" style="max-width: 600px; margin: auto;"><input type="text" name="name" placeholder="Votre Nom" required><input type="email" name="email" placeholder="Votre E-mail" required><textarea name="message" rows="5" placeholder="Votre Message" required></textarea><button type="submit" class="btn">Envoyer</button></form>
                            </section>
                        </div>
                    </main>
                    <footer><div class="social-links">${Object.entries(data.contact.social).filter(([_, v]) => v).map(([k, v]) => `<a href="${v}" target="_blank" aria-label="${k}"><i class="fab fa-${k}"></i></a>`).join('')}</div><p>${data.contact.footerText}</p></footer>
                </div>`
        },
        'corporate': {
            name: 'Corporate Moderne',
            defaults: { colorAccent: '#0052CC', colorHeading: '#172B4D', colorText: '#42526E', colorBg: '#FFFFFF', colorSurface: '#F4F5F7' },
            render: (data, activePage) => `
                <div class="template-corporate">
                    <header>
                        <div class="logo">${data.general.siteTitle}</div>
                        <nav><ul>
                            <li><a href="#accueil" data-page="accueil" class="${activePage === 'accueil' ? 'active' : ''}">Accueil</a></li>
                            <li><a href="#catalogue" data-page="catalogue" class="${activePage === 'catalogue' ? 'active' : ''}">Services</a></li>
                            <li><a href="#contact" data-page="contact" class="${activePage === 'contact' ? 'active' : ''}">Contact</a></li>
                        </ul></nav>
                    </header>
                    <main>
                        <div class="page-content ${activePage === 'accueil' ? 'active' : ''}" id="page-accueil">
                            <section class="hero">
                                <div class="hero-text"><h1>${data.accueil.heroTitle}</h1><p>${data.accueil.heroSubtitle}</p><a href="${data.accueil.ctaLink}" class="btn cta-btn">${data.accueil.ctaText}</a></div>
                                <img class="hero-image" src="${data.accueil.heroImage}" alt="Hero Image">
                            </section>
                             <section class="section"><h2>${data.temoignages.title}</h2><div class="card-grid">${data.temoignages.items.map(t => `<div class="card"><p>"${t.text}"</p><b>- ${t.author}</b></div>`).join('')}</div></section>
                        </div>
                        <div class="page-content ${activePage === 'catalogue' ? 'active' : ''}" id="page-catalogue">
                             <section class="section"><h2>${data.catalogue.pageTitle}</h2><div class="card-grid">${data.catalogue.items.map(i => `<div class="card catalog-item"><h3>${i.name}</h3><p>${i.desc}</p>${i.price ? `<b style="color:var(--color-accent)">${i.price}</b>` : ''}</div>`).join('')}</div></section>
                        </div>
                        <div class="page-content ${activePage === 'contact' ? 'active' : ''}" id="page-contact">
                            <section class="section"><h2>${data.contact.pageTitle}</h2><p style="text-align:center;">${data.contact.introText}</p></section>
                        </div>
                    </main>
                    <footer><p>${data.contact.footerText}</p></footer>
                </div>`
        },
        'portfolio': {
            name: 'Portfolio Créatif',
            defaults: { colorAccent: '#E91E63', colorHeading: '#212121', colorText: '#616161', colorBg: '#FFFFFF', colorSurface: '#FAFAFA' },
            render: (data, activePage) => `
                <div class="template-portfolio">
                     <header>
                        <div class="logo">${data.general.siteTitle}</div>
                        <div class="subtext">${data.general.headerSubtext}</div>
                    </header>
                    <nav><ul>
                        <li><a href="#accueil" data-page="accueil" class="${activePage === 'accueil' ? 'active' : ''}">Galerie</a></li>
                        <li><a href="#contact" data-page="contact" class="${activePage === 'contact' ? 'active' : ''}">À Propos & Contact</a></li>
                    </ul></nav>
                    <main>
                         <div class="page-content ${activePage === 'accueil' ? 'active' : ''}" id="page-accueil">
                            <section class="section"><h2>${data.galerie.pageTitle}</h2><div class="gallery-grid">${data.galerie.images.map(i => `<figure class="gallery-item"><img src="${i.url}" alt="${i.caption}"><figcaption>${i.caption}</figcaption></figure>`).join('')}</div></section>
                        </div>
                         <div class="page-content ${activePage === 'contact' ? 'active' : ''}" id="page-contact">
                            <section class="section"><h2>${data.accueil.aboutTitle}</h2><p style="text-align:center;">${data.accueil.aboutText}</p></section>
                            <section class="section section-alt"><h2>Contact</h2><p style="text-align:center;">${data.contact.email} | ${data.contact.phone}</p></section>
                        </div>
                    </main>
                    <footer><p>${data.contact.footerText}</p></footer>
                </div>`
        }
    };

    // --- 2. DOM Elements ---
    const DOM = {
        tabs: document.querySelectorAll('.tab-btn'), tabContent: document.getElementById('tabContent'), preview: document.getElementById('websitePreview'),
        downloadBtn: document.getElementById('downloadBtn'), exportJsonBtn: document.getElementById('exportJsonBtn'),
        importJsonBtn: document.getElementById('importJsonBtn'), importFileInput: document.getElementById('importFileInput'),
        requestFeatureBtn: document.getElementById('requestFeatureBtn'),
        modal: document.getElementById('featureRequestModal'),
        modalCloseBtn: document.getElementById('modalCloseBtn'),
        featureRequestForm: document.getElementById('featureRequestForm'),
        jsonConfigInput: document.getElementById('jsonConfigInput'),
    };
    let currentCustomizerPage = 'general', currentPreviewPage = 'accueil';

    // --- 3. CORE FUNCTIONS ---

    const updateState = (path, value) => {
        // Simple helper to set a value in a nested object based on a path string
        path.split('.').reduce((acc, key, i, arr) => {
            if (i === arr.length - 1) acc[key] = value;
            return acc[key] || {};
        }, websiteData);
        
        if (path.startsWith('general.color') || path === 'general.theme') applyTheme();
        renderPreview(currentPreviewPage);
    };
    
    // MODIFIED: applyTemplate now also changes the active templateId and merges defaults
    const applyTemplate = (templateId) => {
        const template = templates[templateId];
        if (!template) return;
        
        websiteData.general.templateId = templateId;
        Object.assign(websiteData.general, template.defaults); // Apply template's recommended colors etc.
        
        applyTheme();
        renderPreview(currentPreviewPage);
        renderCustomizerForm(currentCustomizerPage);
    };

    const switchTab = (page) => {
        currentCustomizerPage = page;
        DOM.tabs.forEach(btn => btn.classList.toggle('active', btn.dataset.page === page));
        renderCustomizerForm(page);
    };
    
    const createFormGroup = (path, label, type = 'text', options = {}) => {
        const value = path.split('.').reduce((acc, key) => acc && acc[key], websiteData) ?? '';
        const group = document.createElement('div');
        group.className = `form-group ${type === 'color' ? 'color-input' : ''}`;
        
        let inputEl, labelEl = `<label for="${path}">${label}</label>`;
        if (type === 'color') {
            inputEl = `<input type="color" id="${path}" value="${value}"><span class="color-value">${value}</span>`;
            group.innerHTML = `<div>${labelEl}</div><div>${inputEl}</div>`;
        } else {
            group.innerHTML = labelEl;
            if (type === 'textarea') inputEl = document.createElement('textarea');
            else if (type === 'select') {
                inputEl = document.createElement('select');
                inputEl.innerHTML = options.choices.map(opt => `<option value="${opt.value}" ${value === opt.value ? 'selected' : ''}>${opt.text}</option>`).join('');
            } else {
                inputEl = document.createElement('input'); inputEl.type = type; inputEl.placeholder = options.placeholder || '';
            }
            if (type !== 'select') inputEl.value = value;
            inputEl.id = path;
            group.appendChild(inputEl);
        }
        
        group.addEventListener('input', e => {
            if (e.target.id === path) {
                updateState(path, e.target.value);
                if (type === 'color') e.target.nextElementSibling.textContent = e.target.value;
            }
        });
        return group;
    };

    const renderCustomizerForm = (page) => {
        DOM.tabContent.innerHTML = '';
        const fragment = document.createDocumentFragment();
        const addField = (path, label, type, options) => fragment.appendChild(createFormGroup(path, label, type, options));
        const addDivider = () => { const hr = document.createElement('hr'); hr.className = 'form-divider'; fragment.appendChild(hr); };
        const addSubheading = (text) => { const h = document.createElement('h4'); h.style.marginBottom='10px'; h.textContent = text; fragment.appendChild(h); };

        switch (page) {
            case 'general':
                const templateChoices = Object.keys(templates).map(id => ({ value: id, text: templates[id].name }));
                addField('general.templateId', 'Template du Site', 'select', { choices: templateChoices });
                
                const templateSelect = fragment.querySelector('#general\\.templateId');
                templateSelect.addEventListener('change', (e) => applyTemplate(e.target.value));

                addField('general.siteTitle', 'Titre du site'); addField('general.headerSubtext', 'Slogan / Texte en-tête');
                addField('general.theme', 'Thème de base', 'select', { choices: [{value: 'light', text: 'Clair'}, {value: 'dark', text: 'Sombre'}]});
                addDivider();
                addSubheading('Palette de Couleurs');
                addField('general.colorAccent', 'Accent (boutons, liens)', 'color'); addField('general.colorHeading', 'Titres', 'color'); addField('general.colorText', 'Texte courant', 'color');
                addField('general.colorBg', 'Fond des pages', 'color'); addField('general.colorSurface', 'Surface (cartes, en-tête)', 'color');
                break;
            case 'accueil':
                addField('accueil.heroTitle', 'Titre principal'); addField('accueil.heroSubtitle', 'Sous-titre', 'textarea'); addField('accueil.heroImage', 'URL de l\'image de fond');
                addField('accueil.ctaText', 'Texte du bouton d\'action'); addField('accueil.ctaLink', 'Lien du bouton (ex: #contact)');
                addDivider();
                addField('accueil.aboutTitle', 'Titre section "A Propos"'); addField('accueil.aboutText', 'Texte "A Propos"', 'textarea');
                break;
            case 'catalogue':
                addField('catalogue.pageTitle', 'Titre de la page');
                websiteData.catalogue.items.forEach((_, i) => { addDivider(); addSubheading(`Article ${i + 1}`);
                    addField(`catalogue.items.${i}.name`, 'Nom'); addField(`catalogue.items.${i}.desc`, 'Description', 'textarea');
                    addField(`catalogue.items.${i}.price`, 'Prix'); addField(`catalogue.items.${i}.image`, 'URL Image');
                });
                break;
            case 'galerie':
                addField('galerie.pageTitle', 'Titre de la page');
                websiteData.galerie.images.forEach((_, i) => { addDivider(); addSubheading(`Image ${i + 1}`);
                    addField(`galerie.images.${i}.url`, 'URL Image'); addField(`galerie.images.${i}.caption`, 'Légende');
                });
                break;
            case 'temoignages':
                addField('temoignages.title', 'Titre de la section');
                websiteData.temoignages.items.forEach((_, i) => { addDivider(); addSubheading(`Témoignage ${i + 1}`);
                    addField(`temoignages.items.${i}.text`, 'Texte', 'textarea'); addField(`temoignages.items.${i}.author`, 'Auteur');
                });
                break;
            case 'contact':
                addField('contact.pageTitle', 'Titre de la page'); addField('contact.introText', 'Texte d\'introduction', 'textarea');
                addDivider();
                addField('contact.address', 'Adresse'); addField('contact.phone', 'Téléphone'); addField('contact.email', 'E-mail de contact');
                addDivider();
                addSubheading('Réseaux Sociaux');
                addField('contact.social.facebook', 'Lien Facebook'); addField('contact.social.instagram', 'Lien Instagram'); addField('contact.social.linkedin', 'Lien LinkedIn');
                addDivider();
                addField('contact.footerText', 'Texte du pied de page');
                break;
        }
        DOM.tabContent.appendChild(fragment);
    };
    
    // MODIFIED: renderPreview is now a dispatcher that uses the template's render function
    const renderPreview = (activePage = 'accueil') => {
        currentPreviewPage = activePage;
        const templateId = websiteData.general.templateId;
        const activeTemplate = templates[templateId] || templates['artisan']; // Fallback to default
        
        DOM.preview.innerHTML = activeTemplate.render(websiteData, activePage);
        
        // Re-attach listeners for navigation within the preview
        DOM.preview.querySelectorAll('nav a, .cta-btn').forEach(link => {
            link.addEventListener('click', e => {
                const href = link.getAttribute('href');
                if (href && href.startsWith('#')) {
                    e.preventDefault();
                    const targetPage = href.replace('#', '');
                    renderPreview(targetPage);
                }
            });
        });
    };
    
    const applyTheme = () => {
        const { theme, ...colors } = websiteData.general;
        const root = document.documentElement;
        root.className = theme === 'dark' ? 'dark-theme' : '';
        Object.entries(colors).forEach(([key, value]) => {
            if (key.startsWith('color')) {
                const cssVar = `--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                root.style.setProperty(cssVar, value);
            }
        });
    };

    // --- Fonctions d'Import/Export/Download (largely unchanged) ---
    const exportJson = () => {
        const jsonString = JSON.stringify(websiteData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'config-site.json';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    };

    const importJson = (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                websiteData = importedData;
                applyTheme();
                renderPreview('accueil');
                switchTab('general');
                alert('Configuration importée avec succès !');
            } catch (error) {
                alert('Erreur : Le fichier de configuration est invalide.');
                console.error("Erreur d'analyse JSON:", error);
            }
        };
        reader.readAsText(file);
    };

    const downloadWebsite = () => {
        const { siteTitle, theme, ...colors } = websiteData.general;
        const finalHtmlContent = DOM.preview.innerHTML;
        const finalCss = document.querySelector('#main-styles').textContent;
        const inlineStyles = Object.entries(colors).filter(([k]) => k.startsWith('color')).map(([k, v]) => `--${k.replace(/([A-Z])/g, '-$1').toLowerCase()}: ${v};`).join(' ');

        const fullHtml = `<!DOCTYPE html>
<html lang="fr" class="${theme === 'dark' ? 'dark-theme' : ''}" style="${inlineStyles}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${siteTitle}</title>
    <style>${finalCss}</style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer><\/script>
</head>
<body>
    <div id="websitePreview">${finalHtmlContent}</div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const links = document.querySelectorAll('nav a, .cta-btn');
            const pages = document.querySelectorAll('.page-content');
            const navLinks = Array.from(document.querySelectorAll('nav a'));
            const showPage = (pageId) => {
                pages.forEach(p => p.classList.toggle('active', p.id === 'page-' + pageId));
                navLinks.forEach(l => l.classList.toggle('active', l.dataset.page === pageId));
                window.scrollTo(0, 0);
            };
            links.forEach(link => {
                link.addEventListener('click', e => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('#')) {
                        e.preventDefault();
                        const targetPage = href.replace('#', '');
                        if (document.getElementById('page-' + targetPage)) {
                            showPage(targetPage);
                        }
                    }
                });
            });
            // Show the first page on load
            if(navLinks.length > 0) {
                 showPage(navLinks[0].dataset.page);
            }
        });
    <\/script>
</body></html>`;
        const blob = new Blob([fullHtml.trim()], { type: 'text/html' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'index.html';
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    };

    // --- 4. INITIALIZATION & EVENT LISTENERS ---
    
    // Tabs
    DOM.tabs.forEach(btn => btn.addEventListener('click', () => switchTab(btn.dataset.page)));
    
    // Main Buttons
    DOM.downloadBtn.addEventListener('click', downloadWebsite);
    DOM.exportJsonBtn.addEventListener('click', exportJson);
    DOM.importJsonBtn.addEventListener('click', () => DOM.importFileInput.click());
    DOM.importFileInput.addEventListener('change', importJson);
    
    // Modal Logic
    DOM.requestFeatureBtn.addEventListener('click', () => DOM.modal.classList.add('visible'));
    DOM.modalCloseBtn.addEventListener('click', () => DOM.modal.classList.remove('visible'));
    DOM.modal.addEventListener('click', (e) => { if (e.target === DOM.modal) DOM.modal.classList.remove('visible'); });
    DOM.featureRequestForm.addEventListener('submit', (e) => {
        // Avant d'envoyer, injecter le JSON
        DOM.jsonConfigInput.value = JSON.stringify(websiteData, null, 2);
        // Le formulaire s'enverra normalement après ça
    });
    
    // Initial Load
    applyTheme();
    switchTab(currentCustomizerPage);
    renderPreview(currentPreviewPage);
});
</script>
</body>
</html>